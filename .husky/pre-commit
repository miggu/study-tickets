if ! git diff --cached --name-only --diff-filter=ACMR | rg . >/dev/null; then
  exit 0
fi

matched_files="$(mktemp)"
trap 'rm -f "$matched_files"' EXIT

git diff --cached --name-only --diff-filter=ACMR -z | while IFS= read -r -d '' file; do
  if git diff --cached -U0 -- "$file" | rg "^\+.*console\.(log|debug|info|warn|error)\b" >/dev/null; then
    printf "%s\n" "$file" >> "$matched_files"
  fi
done

if [ -s "$matched_files" ]; then
  echo "Error: console statements found in staged changes."
  echo "Files:"
  cat "$matched_files"
  echo "Remove them before committing."
  exit 1
fi

git diff --cached --name-only --diff-filter=ACMR -z | xargs -0 prettier --write --ignore-unknown
git update-index --again
